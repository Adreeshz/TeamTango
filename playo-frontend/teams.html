<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Teams - TeamTango</title>
    <link rel="stylesheet" href="styles.css">
    <script src="utils.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
    </style>
    
    <!-- Authentication Check -->
    <script>
        // Check authentication on page load
        function checkAuthentication() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token || !(user.id || user.userId)) {
                // Show loading message briefly then redirect
                document.body.innerHTML = `
                    <div class="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div class="text-center">
                            <i data-feather="lock" class="h-16 w-16 text-red-500 mx-auto mb-4"></i>
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Authentication Required</h2>
                            <p class="text-gray-600 mb-4">You need to log in to access teams.</p>
                            <p class="text-sm text-gray-500">Redirecting to login page...</p>
                        </div>
                    </div>
                `;
                
                // Replace feather icons and redirect after 2 seconds
                if (typeof feather !== 'undefined') feather.replace();
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                
                return false;
            }
            
            return true;
        }
        
        // Check auth immediately when script loads
        if (!checkAuthentication()) {
            // Stop further script execution if not authenticated
            throw new Error('Authentication required');
        }
    </script>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="index.html" class="flex-shrink-0 flex items-center">
                        <i data-feather="activity" class="text-primary-600 h-8 w-8"></i>
                        <span class="ml-2 text-xl font-bold text-primary-600">TeamTango</span>
                    </a>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="player-dashboard.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Dashboard</a>
                        <a href="teams.html" class="border-primary-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">My Teams</a>
                        <a href="venues.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Venues</a>
                        <a href="matches.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Matches</a>
                        <a href="payments.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Payments</a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="p-1 rounded-full text-gray-400 hover:text-gray-500 focus:outline-none">
                        <i data-feather="bell"></i>
                    </button>
                    
                    <!-- User Menu -->
                    <div class="relative">
                        <button onclick="toggleUserMenu()" class="flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            <div class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center">
                                <span id="user-initials" class="text-primary-600 font-medium text-sm">U</span>
                            </div>
                            <span id="user-name" class="ml-2 text-gray-700 font-medium">User</span>
                        </button>
                        
                        <div id="user-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                            <a href="#" onclick="logout()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign out</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="md:flex md:items-center md:justify-between mb-8">
            <div class="flex-1 min-w-0">
                <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                    Teams
                </h2>
                <p class="mt-1 text-sm text-gray-500">
                    Discover and join teams, or create your own.
                </p>
            </div>
            <div class="mt-4 flex md:mt-0 md:ml-4">
                <button type="button" id="create-team-btn" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700">
                    <i data-feather="plus" class="mr-2 h-4 w-4"></i>
                    Create Team
                </button>
            </div>
        </div>

        <!-- Advanced Team Filters -->
        <div class="bg-white p-6 rounded-lg shadow mb-8">
            <div class="mb-4">
                <h3 class="text-lg font-medium text-gray-900 mb-2">Filter Teams</h3>
                <p class="text-sm text-gray-500">Use the filters below to find teams that match your preferences</p>
            </div>
            
            <!-- First Row of Filters -->
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4 mb-4">
                <div>
                    <label for="team-name-filter" class="block text-sm font-medium text-gray-700 mb-2">Team Name</label>
                    <input type="text" id="team-name-filter" placeholder="Enter team name..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                </div>
                <div>
                    <label for="sport-filter" class="block text-sm font-medium text-gray-700 mb-2">Sport</label>
                    <select id="sport-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                        <option value="">All Sports</option>
                        <option value="Basketball">Basketball</option>
                        <option value="Football">Football</option>
                        <option value="Tennis">Tennis</option>
                        <option value="Badminton">Badminton</option>
                        <option value="Cricket">Cricket</option>
                        <option value="Volleyball">Volleyball</option>
                    </select>
                </div>
                <div>
                    <label for="captain-name-filter" class="block text-sm font-medium text-gray-700 mb-2">Captain Name</label>
                    <input type="text" id="captain-name-filter" placeholder="Enter captain name..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                </div>
                <div>
                    <label for="team-id-filter" class="block text-sm font-medium text-gray-700 mb-2">Team ID</label>
                    <input type="number" id="team-id-filter" placeholder="Enter team ID..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                </div>
            </div>
            
            <!-- Second Row - Gender & Composition Filters -->
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4 mb-4">
                <div>
                    <label for="captain-gender-filter" class="block text-sm font-medium text-gray-700 mb-2">Captain Gender</label>
                    <select id="captain-gender-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                        <option value="">Any Captain</option>
                        <option value="Male">Male Captain</option>
                        <option value="Female">Female Captain</option>
                        <option value="Other">Other Gender Captain</option>
                    </select>
                </div>
                <div>
                    <label for="team-composition-filter" class="block text-sm font-medium text-gray-700 mb-2">Team Composition</label>
                    <select id="team-composition-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                        <option value="">Any Composition</option>
                        <option value="All Male">All Male</option>
                        <option value="All Female">All Female</option>
                        <option value="Mixed">Mixed Gender</option>
                        <option value="Majority Male">Majority Male</option>
                        <option value="Majority Female">Majority Female</option>
                    </select>
                </div>
                <div>
                    <label for="member-count-min-filter" class="block text-sm font-medium text-gray-700 mb-2">Min Members</label>
                    <input type="number" id="member-count-min-filter" placeholder="Min members..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                </div>
                <div>
                    <label for="member-count-max-filter" class="block text-sm font-medium text-gray-700 mb-2">Max Members</label>
                    <input type="number" id="member-count-max-filter" placeholder="Max members..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                </div>
            </div>
            
            <!-- Filter Actions -->
            <div class="flex flex-wrap gap-3">
                <button id="apply-filters-btn" class="bg-primary-600 text-white px-6 py-2 rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors">
                    <i data-feather="filter" class="inline w-4 h-4 mr-2"></i>
                    Apply Filters
                </button>
                <button id="clear-filters-btn" class="bg-gray-100 text-gray-700 px-6 py-2 rounded-md hover:bg-gray-200 focus:outline-none transition-colors">
                    <i data-feather="x" class="inline w-4 h-4 mr-2"></i>
                    Clear All
                </button>
                <div class="ml-auto text-sm text-gray-600 flex items-center">
                    <span id="filter-count">Showing all teams</span>
                </div>
            </div>
        </div>

        <!-- Teams Grid -->
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3" id="teams-grid">
            <!-- Teams will be loaded here dynamically -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-12">
            <i data-feather="users" class="mx-auto h-12 w-12 text-gray-400"></i>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No teams</h3>
            <p class="mt-1 text-sm text-gray-500">Get started by creating your first team.</p>
            <div class="mt-6">
                <button type="button" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">
                    <i data-feather="plus" class="mr-2 h-4 w-4"></i>
                    New Team
                </button>
            </div>
        </div>
    </div>

    <!-- Create Team Modal -->
    <div id="team-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Create New Team</h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-600">
                        <i data-feather="x"></i>
                    </button>
                </div>
                <form id="team-form">
                    <div class="mb-4">
                        <label for="team-name" class="block text-sm font-medium text-gray-700 mb-2">Team Name</label>
                        <input type="text" id="team-name" name="teamName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="sport-select" class="block text-sm font-medium text-gray-700 mb-2">Sport</label>
                        <select id="sport-select" name="sportId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500" required>
                            <option value="">Select a sport</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="team-description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="team-description" name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-md hover:bg-primary-700">
                            Create Team
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        feather.replace();
        
        const API_BASE_URL = 'http://localhost:5000/api';
        
        let allTeams = [];
        let filteredTeams = [];

        // User menu toggle
        function toggleUserMenu() {
            const menu = document.getElementById('user-menu');
            menu.classList.toggle('hidden');
        }

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // Close user menu when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.getElementById('user-menu');
            const userButton = event.target.closest('button[onclick*="toggleUserMenu"]');
            
            if (!userButton && userMenu && !userMenu.classList.contains('hidden')) {
                userMenu.classList.add('hidden');
            }
        });

        
        // Load teams with enhanced gender data
        async function loadTeams() {
            try {
                // Add cache-busting parameter to force fresh data
                const response = await fetch(`${API_BASE_URL}/teams?_t=` + Date.now());
                const data = await response.json();
                let teams = data.teams || data;
                
                console.log('Loaded teams data:', teams.length, 'teams');
                
                // Enhance team data with gender composition calculation
                const enhancedTeams = teams.map(team => {
                    // Calculate composition from backend-provided counts
                    const maleCount = team.MaleMembers || 0;
                    const femaleCount = team.FemaleMembers || 0;
                    const otherCount = team.OtherMembers || 0;
                    
                    let composition;
                    if (femaleCount === 0 && otherCount === 0 && maleCount > 0) {
                        composition = "All Male";
                    } else if (maleCount === 0 && otherCount === 0 && femaleCount > 0) {
                        composition = "All Female";
                    } else if (maleCount > femaleCount + otherCount) {
                        composition = "Majority Male";
                    } else if (femaleCount > maleCount + otherCount) {
                        composition = "Majority Female";
                    } else if (maleCount > 0 || femaleCount > 0) {
                        composition = "Mixed";
                    } else {
                        composition = "Unknown";
                    }
                    
                    return { 
                        ...team, 
                        TeamComposition: composition,
                        MaleMembers: maleCount,
                        FemaleMembers: femaleCount,
                        OtherMembers: otherCount
                    };
                });
                
                allTeams = enhancedTeams;
                filteredTeams = enhancedTeams;
                displayTeams(enhancedTeams);
                updateFilterCount();
            } catch (error) {
                console.log('Using sample team data');
                allTeams = sampleTeams;
                filteredTeams = sampleTeams;
                displayTeams(sampleTeams);
                updateFilterCount();
            }
        }

        // Analyze team gender composition
        async function analyzeTeamGender(team) {
            try {
                // Get gender info for captain
                const captainGender = await getUserGender(team.CaptainID);
                
                // Get gender info for all members
                const memberGenders = await Promise.all(
                    team.members.map(member => getUserGender(member.UserID))
                );
                
                const maleCount = memberGenders.filter(g => g === 'Male').length;
                const femaleCount = memberGenders.filter(g => g === 'Female').length;
                const otherCount = memberGenders.filter(g => g === 'Other').length;
                const totalMembers = team.members.length;
                
                // Determine team composition
                let composition;
                if (femaleCount === 0 && otherCount === 0) {
                    composition = "All Male";
                } else if (maleCount === 0 && otherCount === 0) {
                    composition = "All Female";
                } else if (maleCount > femaleCount + otherCount) {
                    composition = "Majority Male";
                } else if (femaleCount > maleCount + otherCount) {
                    composition = "Majority Female";
                } else {
                    composition = "Mixed";
                }
                
                return {
                    CaptainGender: captainGender,
                    MaleMembers: maleCount,
                    FemaleMembers: femaleCount,
                    OtherMembers: otherCount,
                    TeamComposition: composition
                };
            } catch (error) {
                console.log('Failed to analyze team gender:', error);
                return {
                    CaptainGender: "Unknown",
                    MaleMembers: 0,
                    FemaleMembers: 0,
                    OtherMembers: 0,
                    TeamComposition: "Unknown"
                };
            }
        }

        // Get user gender from backend (you might need to implement this endpoint)
        async function getUserGender(userId) {
            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}`);
                const data = await response.json();
                return data.user?.Gender || "Unknown";
            } catch (error) {
                // Fallback to mock gender data
                const mockGenders = ["Male", "Female", "Male", "Female", "Other"];
                return mockGenders[userId % mockGenders.length];
            }
        }

        // Display teams with enhanced gender information
        function displayTeams(teams) {
            const teamsGrid = document.getElementById('teams-grid');
            const emptyState = document.getElementById('empty-state');
            
            // Get current user information
            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
            const currentUserId = currentUser.id || currentUser.userId; // Try both id and userId
            
            console.log('Current user data:', currentUser);
            console.log('Current user ID:', currentUserId, 'Type:', typeof currentUserId);

            if (teams.length === 0) {
                teamsGrid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            teamsGrid.classList.remove('hidden');

            teamsGrid.innerHTML = teams.map(team => `
                <div class="bg-white overflow-hidden shadow rounded-lg hover:shadow-lg transition-shadow duration-300">
                    <div class="px-6 py-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-lg font-medium text-gray-900 truncate" title="${team.TeamName}">${team.TeamName}</h3>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800">
                                ${team.Sport || 'Mixed'}
                            </span>
                        </div>
                        
                        ${team.CaptainName ? `<div class="flex items-center text-sm text-gray-600 mb-2">
                            <i data-feather="award" class="h-4 w-4 mr-1"></i>
                            <span>Captain: ${team.CaptainName}</span>
                            ${team.CaptainGender ? `<span class="ml-2 px-2 py-0.5 text-xs rounded-full ${
                                team.CaptainGender === 'Male' ? 'bg-blue-100 text-blue-800' : 
                                team.CaptainGender === 'Female' ? 'bg-pink-100 text-pink-800' : 
                                'bg-purple-100 text-purple-800'
                            }">${team.CaptainGender}</span>` : ''}
                        </div>` : ''}
                        
                        <p class="text-sm text-gray-500 mb-3">${team.Description || 'No description'}</p>
                        
                        <!-- Team Composition -->
                        ${team.TeamComposition ? `<div class="mb-3">
                            <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
                                <span>Team Composition</span>
                                <span class="font-medium px-2 py-0.5 rounded-full ${
                                    team.TeamComposition === 'All Male' ? 'bg-blue-100 text-blue-800' :
                                    team.TeamComposition === 'All Female' ? 'bg-pink-100 text-pink-800' :
                                    team.TeamComposition === 'Mixed' ? 'bg-green-100 text-green-800' :
                                    team.TeamComposition.includes('Majority') ? 'bg-yellow-100 text-yellow-800' :
                                    'bg-gray-100 text-gray-800'
                                }">${team.TeamComposition}</span>
                            </div>
                            ${(team.MaleMembers !== undefined || team.FemaleMembers !== undefined) ? `<div class="flex space-x-2 text-xs">
                                ${team.MaleMembers !== undefined ? `<span class="flex items-center">
                                    <div class="w-2 h-2 bg-blue-500 rounded-full mr-1"></div>
                                    ${team.MaleMembers} Male
                                </span>` : ''}
                                ${team.FemaleMembers !== undefined ? `<span class="flex items-center">
                                    <div class="w-2 h-2 bg-pink-500 rounded-full mr-1"></div>
                                    ${team.FemaleMembers} Female
                                </span>` : ''}
                                ${team.OtherMembers ? `<span class="flex items-center">
                                    <div class="w-2 h-2 bg-purple-500 rounded-full mr-1"></div>
                                    ${team.OtherMembers} Other
                                </span>` : ''}
                            </div>` : ''}
                        </div>` : ''}
                        
                        <div class="flex items-center justify-between text-sm text-gray-500">
                            <div class="flex items-center">
                                <i data-feather="users" class="h-4 w-4 mr-1"></i>
                                ${team.MemberCount || 0} members
                            </div>
                            <div class="flex items-center">
                                <i data-feather="calendar" class="h-4 w-4 mr-1"></i>
                                ${new Date(team.CreatedAt || team.CreatedDate || Date.now()).toLocaleDateString()}
                            </div>
                        </div>
                        
                        <div class="mt-2 text-xs text-gray-400">
                            ID: ${team.TeamID} ${team.TotalBookings ? `| ${team.TotalBookings} bookings` : ''}
                        </div>
                    </div>
                    <div class="bg-gray-50 px-6 py-3">
                        <div class="flex justify-between">
                            <button onclick="joinTeam(${team.TeamID})" class="text-primary-600 hover:text-primary-900 text-sm font-medium">
                                Join Team
                            </button>
                            <div class="flex space-x-2">
                                <button onclick="viewTeamDetails(${team.TeamID})" class="text-gray-400 hover:text-gray-600" title="View Details">
                                    <i data-feather="eye" class="h-4 w-4"></i>
                                </button>
                                ${(() => {
                                    // Convert both to numbers for proper comparison
                                    const captainId = parseInt(team.CaptainID);
                                    const userId = parseInt(currentUserId);
                                    const isCaptain = captainId === userId;
                                    
                                    return isCaptain ? `
                                    <button onclick="editTeam(${team.TeamID})" class="text-gray-400 hover:text-primary-600" title="Edit Team (Captain)">
                                        <i data-feather="edit-2" class="h-4 w-4"></i>
                                    </button>
                                    <button class="text-gray-400 hover:text-red-600" onclick="deleteTeam(${team.TeamID})" title="Delete Team (Captain)">
                                        <i data-feather="trash-2" class="h-4 w-4"></i>
                                    </button>
                                    ` : '';
                                })()}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            feather.replace();
        }

        // Advanced team filtering function
        function applyTeamFilters() {
            const filters = {
                teamName: document.getElementById('team-name-filter').value.toLowerCase().trim(),
                sport: document.getElementById('sport-filter').value,
                captainName: document.getElementById('captain-name-filter').value.toLowerCase().trim(),
                teamId: document.getElementById('team-id-filter').value,
                captainGender: document.getElementById('captain-gender-filter').value,
                teamComposition: document.getElementById('team-composition-filter').value,
                memberCountMin: document.getElementById('member-count-min-filter').value,
                memberCountMax: document.getElementById('member-count-max-filter').value
            };

            filteredTeams = allTeams.filter(team => {
                // Team Name filter
                if (filters.teamName && !team.TeamName.toLowerCase().includes(filters.teamName)) {
                    return false;
                }

                // Sport filter
                if (filters.sport && team.Sport !== filters.sport) {
                    return false;
                }

                // Captain Name filter
                if (filters.captainName && team.CaptainName && !team.CaptainName.toLowerCase().includes(filters.captainName)) {
                    return false;
                }

                // Team ID filter
                if (filters.teamId && team.TeamID !== parseInt(filters.teamId)) {
                    return false;
                }

                // Captain Gender filter
                if (filters.captainGender && team.CaptainGender !== filters.captainGender) {
                    return false;
                }

                // Team Composition filter
                if (filters.teamComposition && team.TeamComposition !== filters.teamComposition) {
                    return false;
                }

                // Member count range filter
                const memberCount = team.MemberCount || 0;
                if (filters.memberCountMin && memberCount < parseInt(filters.memberCountMin)) {
                    return false;
                }
                if (filters.memberCountMax && memberCount > parseInt(filters.memberCountMax)) {
                    return false;
                }

                return true;
            });

            displayTeams(filteredTeams);
            updateFilterCount();
        }

        // Update filter count display
        function updateFilterCount() {
            const filterCountEl = document.getElementById('filter-count');
            const total = allTeams.length;
            const filtered = filteredTeams.length;
            
            if (filtered === total) {
                filterCountEl.textContent = `Showing all ${total} teams`;
            } else {
                filterCountEl.textContent = `Showing ${filtered} of ${total} teams`;
            }
        }

        // Clear all filters
        function clearAllFilters() {
            document.getElementById('team-name-filter').value = '';
            document.getElementById('sport-filter').value = '';
            document.getElementById('captain-name-filter').value = '';
            document.getElementById('team-id-filter').value = '';
            document.getElementById('captain-gender-filter').value = '';
            document.getElementById('team-composition-filter').value = '';
            document.getElementById('member-count-min-filter').value = '';
            document.getElementById('member-count-max-filter').value = '';
            
            filteredTeams = allTeams;
            displayTeams(allTeams);
            updateFilterCount();
        }

        // Initialize filter event listeners
        function initializeFilterListeners() {
            // Apply filters button
            document.getElementById('apply-filters-btn').addEventListener('click', applyTeamFilters);
            
            // Clear filters button
            document.getElementById('clear-filters-btn').addEventListener('click', clearAllFilters);
            
            // Real-time filtering for text inputs (with debounce)
            const textInputs = [
                'team-name-filter',
                'captain-name-filter',
                'team-id-filter',
                'member-count-min-filter',
                'member-count-max-filter'
            ];
            
            textInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                let debounceTimer;
                
                input.addEventListener('input', () => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        applyTeamFilters();
                    }, 300);
                });
            });
            
            // Instant filtering for select inputs
            document.getElementById('sport-filter').addEventListener('change', applyTeamFilters);
            document.getElementById('captain-gender-filter').addEventListener('change', applyTeamFilters);
            document.getElementById('team-composition-filter').addEventListener('change', applyTeamFilters);
        }

        // Load sports for the dropdown
        async function loadSports() {
            try {
                const response = await fetch(`${API_BASE_URL}/sports`);
                const sports = await response.json();
                populateSportsDropdown(sports);
            } catch (error) {
                console.log('Using sample sports data');
                populateSportsDropdown(sampleSports);
            }
        }

        // Populate sports dropdown
        function populateSportsDropdown(sports) {
            const sportSelect = document.getElementById('sport-select');
            sportSelect.innerHTML = '<option value="">Select a sport</option>';
            
            sports.forEach(sport => {
                const option = document.createElement('option');
                option.value = sport.SportID;
                option.textContent = sport.SportName;
                sportSelect.appendChild(option);
            });
        }

        // Reset modal to create mode
        function resetModalToCreateMode() {
            const modalTitle = document.querySelector('#team-modal h3');
            const submitButton = document.querySelector('#team-form button[type="submit"]');
            modalTitle.textContent = 'Create New Team';
            submitButton.textContent = 'Create Team';
            
            // Clear form data attributes
            teamForm.removeAttribute('data-team-id');
            teamForm.removeAttribute('data-mode');
            teamForm.reset();
        }

        // Modal functionality
        const modal = document.getElementById('team-modal');
        const createTeamBtn = document.getElementById('create-team-btn');
        const closeModalBtn = document.getElementById('close-modal');
        const cancelBtn = document.getElementById('cancel-btn');
        const teamForm = document.getElementById('team-form');

        createTeamBtn.addEventListener('click', () => {
            resetModalToCreateMode();
            modal.classList.remove('hidden');
        });

        closeModalBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            resetModalToCreateMode();
        });

        cancelBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            resetModalToCreateMode();
        });

        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
                resetModalToCreateMode();
            }
        });

        // Handle team form submission (create or edit)
        teamForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(teamForm);
            const teamData = {
                TeamName: formData.get('teamName'),
                SportID: formData.get('sportId'),
                Description: formData.get('description')
            };
            
            const mode = teamForm.dataset.mode || 'create';
            const teamId = teamForm.dataset.teamId;

            try {
                const token = localStorage.getItem('token');
                let response;
                
                if (mode === 'edit' && teamId) {
                    // Update existing team
                    response = await fetch(`${API_BASE_URL}/teams/update/${teamId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(teamData)
                    });
                } else {
                    // Create new team
                    response = await fetch(`${API_BASE_URL}/teams/create`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(teamData)
                    });
                }

                if (response.ok) {
                    const result = await response.json();
                    console.log(`Team ${mode}d successfully:`, result);
                    
                    // Close modal and reset form
                    modal.classList.add('hidden');
                    teamForm.reset();
                    
                    // Reset modal to create mode
                    resetModalToCreateMode();
                    
                    // Refresh teams list
                    setTimeout(() => {
                        console.log('Refreshing teams list...');
                        loadTeams();
                    }, 500);
                    
                    alert(`Team ${mode}d successfully!`);
                } else {
                    const errorData = await response.json().catch(() => ({ message: 'Unknown error' }));
                    console.error(`Team ${mode} failed:`, response.status, errorData);
                    alert(`Error ${mode}ing team: ` + (errorData.message || response.status));
                }
            } catch (error) {
                console.error(`Error ${mode}ing team:`, error);
                alert(`Error ${mode}ing team: ` + error.message);
            }
        });

        // Join team function
        async function joinTeam(teamId) {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Please log in to join teams');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/teams/${teamId}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ position: 'Player' })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Successfully joined team!');
                    loadTeams(); // Reload teams to update member count
                } else {
                    alert(data.message || 'Failed to join team');
                }
            } catch (error) {
                console.log('Error joining team:', error);
                alert('Successfully requested to join team!');
            }
        }

        // Edit team function
        async function editTeam(teamId) {
            try {
                console.log('Editing team:', teamId);
                
                // Fetch team details
                const response = await fetch(`${API_BASE_URL}/teams/${teamId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch team details');
                }
                
                const team = await response.json();
                console.log('Team data for editing:', team);
                
                // Populate modal with existing data
                document.getElementById('team-name').value = team.TeamName || '';
                document.getElementById('sport-select').value = team.SportID || '';
                document.getElementById('team-description').value = team.Description || '';
                
                // Change modal title and button text for edit mode
                const modalTitle = document.querySelector('#team-modal h3');
                const submitButton = document.querySelector('#team-form button[type="submit"]');
                modalTitle.textContent = 'Edit Team';
                submitButton.textContent = 'Update Team';
                
                // Store the team ID for later use
                document.getElementById('team-form').dataset.teamId = teamId;
                document.getElementById('team-form').dataset.mode = 'edit';
                
                // Show modal
                document.getElementById('team-modal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading team for editing:', error);
                alert('Error loading team details. Please try again.');
            }
        }

        // View team details function
        async function viewTeamDetails(teamId) {
            const team = allTeams.find(t => t.TeamID === teamId);
            if (!team) return;

            try {
                // Fetch team members from backend
                const response = await fetch(`${API_BASE_URL}/teams/${teamId}/members`);
                const data = await response.json();
                
                if (data.members && data.members.length > 0) {
                    // Create modal content with member details
                    const membersHTML = data.members.map(member => `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg mb-2">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">
                                    ${member.MemberName} 
                                    ${member.Role === 'Captain' ? '<span class="ml-2 px-2 py-0.5 text-xs bg-yellow-100 text-yellow-800 rounded-full">Captain</span>' : ''}
                                </div>
                                <div class="text-sm text-gray-600">
                                    <div>${member.Email}</div>
                                    <div>${member.PhoneNumber}</div>
                                    <div>${member.Address}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="inline-block px-2 py-1 text-xs rounded-full ${
                                    member.Gender === 'Male' ? 'bg-blue-100 text-blue-800' : 
                                    member.Gender === 'Female' ? 'bg-pink-100 text-pink-800' : 
                                    'bg-purple-100 text-purple-800'
                                }">${member.Gender}</span>
                                <div class="text-xs text-gray-500 mt-1">Joined: ${new Date(member.JoinedDate).toLocaleDateString()}</div>
                            </div>
                        </div>
                    `).join('');

                    // Show modal with team details and members
                    const modalHTML = `
                        <div id="team-details-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" onclick="closeTeamDetailsModal(event)">
                            <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white" onclick="event.stopPropagation()">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-2xl font-bold text-gray-900">${team.TeamName}</h3>
                                    <button onclick="closeTeamDetailsModal()" class="text-gray-400 hover:text-gray-600">
                                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                                <!-- Team Info Section -->
                                <div class="mb-4 bg-gray-50 p-4 rounded-lg">
                                    <div class="grid grid-cols-2 gap-3 text-sm">
                                        <div><span class="font-semibold">Sport:</span> ${team.Sport}</div>
                                        <div><span class="font-semibold">Captain:</span> ${team.CaptainName}</div>
                                        <div><span class="font-semibold">Total Members:</span> ${team.MemberCount || 0}</div>
                                        <div><span class="font-semibold">Composition:</span> <span class="px-2 py-0.5 rounded-full text-xs ${
                                            team.TeamComposition === 'All Male' ? 'bg-blue-100 text-blue-800' :
                                            team.TeamComposition === 'All Female' ? 'bg-pink-100 text-pink-800' :
                                            'bg-green-100 text-green-800'
                                        }">${team.TeamComposition || 'Unknown'}</span></div>
                                        ${team.MaleMembers !== undefined ? `<div><span class="font-semibold">Male:</span> ${team.MaleMembers}</div>` : ''}
                                        ${team.FemaleMembers !== undefined ? `<div><span class="font-semibold">Female:</span> ${team.FemaleMembers}</div>` : ''}
                                    </div>
                                </div>
                                
                                <!-- Performance Stats Section -->
                                ${(team.TotalMatches || team.Wins) ? `
                                <div class="mb-4">
                                    <h4 class="text-lg font-semibold mb-3 flex items-center">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                        Team Performance
                                    </h4>
                                    <div class="grid grid-cols-3 gap-4">
                                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                                            <div class="text-3xl font-bold text-blue-600">${team.TotalMatches || 0}</div>
                                            <div class="text-sm text-gray-600 mt-1">Total Matches</div>
                                        </div>
                                        <div class="bg-green-50 p-4 rounded-lg text-center">
                                            <div class="text-3xl font-bold text-green-600">${team.Wins || 0}</div>
                                            <div class="text-sm text-gray-600 mt-1">Wins</div>
                                        </div>
                                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                                            <div class="text-3xl font-bold text-purple-600">${team.TotalMatches > 0 ? ((team.Wins / team.TotalMatches) * 100).toFixed(1) : 0}%</div>
                                            <div class="text-sm text-gray-600 mt-1">Win Rate</div>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                                <div class="border-t pt-4">
                                    <h4 class="text-lg font-semibold mb-3">Team Members (${data.members.length})</h4>
                                    <div class="max-h-96 overflow-y-auto">
                                        ${membersHTML}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Add modal to page
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                } else {
                    alert('No members found for this team');
                }
            } catch (error) {
                console.error('Error fetching team details:', error);
                // Fallback to basic alert
                alert(`Team Details:
Name: ${team.TeamName}
Sport: ${team.Sport}
Captain: ${team.CaptainName}
Members: ${team.MemberCount || 0}
Composition: ${team.TeamComposition || 'Unknown'}`);
            }
        }

        function closeTeamDetailsModal(event) {
            const modal = document.getElementById('team-details-modal');
            if (modal && (!event || event.target === modal || event.type === 'click')) {
                modal.remove();
            }
        }

        // Delete team
        async function deleteTeam(teamId) {
            if (!confirm('Are you sure you want to delete this team?')) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/teams/delete/${teamId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    alert('Team deleted successfully!');
                    loadTeams(); // Reload teams
                } else {
                    const errorData = await response.json().catch(() => ({ message: 'Error deleting team' }));
                    alert(errorData.message || 'Error deleting team');
                }
            } catch (error) {
                console.log('Error deleting team:', error);
                // For demo purposes, remove from sample data
                const index = allTeams.findIndex(t => t.TeamID == teamId);
                if (index > -1) {
                    allTeams.splice(index, 1);
                    applyTeamFilters(); // Re-apply current filters
                }
            }
        }

        // Dashboard redirect function
        function redirectToDashboard() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token || !(user.id || user.userId)) {
                window.location.href = 'login.html';
                return;
            }
            
            const userType = user.userType || user.roleId;
            
            if (userType === 'player' || userType === 1) {
                window.location.href = 'player-dashboard.html';
            } else if (userType === 'venue_owner' || userType === 2) {
                window.location.href = 'venue-owner-dashboard.html';
            } else if (userType === 'admin' || userType === 3) {
                window.location.href = 'admin-dashboard.html';
            } else {
                window.location.href = 'index.html';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load initial data
            loadTeams().then(() => {
                // Initialize filter count after teams are loaded
                updateFilterCount();
            });
            loadSports();
            
            // Initialize filter event listeners
            initializeFilterListeners();
        });
    </script>
</body>
</html>