<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payments - TeamTango</title>
    <link rel="stylesheet" href="styles.css">
    <script src="utils.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
    </style>
    
    <!-- Authentication Check -->
    <script>
        function checkAuthentication() {
            const token = localStorage.getItem('authToken');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token || !(user.id || user.userId)) {
                document.body.innerHTML = `
                    <div class="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div class="text-center">
                            <i data-feather="lock" class="h-16 w-16 text-red-500 mx-auto mb-4"></i>
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Authentication Required</h2>
                            <p class="text-gray-600 mb-4">Please log in to access payments.</p>
                            <button onclick="window.location.href='login.html'" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-4 rounded">
                                Go to Login
                            </button>
                        </div>
                    </div>
                `;
                feather.replace();
                return false;
            }
            return true;
        }

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (checkAuthentication()) {
                initializePage();
            }
        });
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-primary-600">TeamTango</h1>
                    </div>
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="dashboard.html" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Home</a>
                            <a href="venues.html" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Venues</a>
                            <a href="payments.html" class="border-primary-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Payments</a>
                            <a href="teams.html" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Teams</a>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="redirectToDashboard()" class="text-gray-500 hover:text-gray-700">
                        <i data-feather="user"></i>
                    </button>
                    <button onclick="logout()" class="text-gray-500 hover:text-red-600">
                        <i data-feather="log-out"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Payment Management</h1>
            <p class="mt-2 text-gray-600">Track your payments, process new payments, and manage payment history.</p>
        </div>

        <!-- Payment Stats Cards (for venue owners) -->
        <div id="payment-stats" class="hidden mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i data-feather="dollar-sign" class="h-6 w-6 text-green-400"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Total Revenue</dt>
                                    <dd class="text-lg font-medium text-gray-900" id="total-revenue">₹0</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i data-feather="check-circle" class="h-6 w-6 text-blue-400"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Completed</dt>
                                    <dd class="text-lg font-medium text-gray-900" id="completed-payments">0</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i data-feather="clock" class="h-6 w-6 text-yellow-400"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Pending</dt>
                                    <dd class="text-lg font-medium text-gray-900" id="pending-payments">0</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i data-feather="x-circle" class="h-6 w-6 text-red-400"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Failed</dt>
                                    <dd class="text-lg font-medium text-gray-900" id="failed-payments">0</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Actions (for players) -->
        <div id="player-actions" class="hidden mb-8">
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">Quick Actions</h2>
                <div class="flex flex-wrap gap-4">
                    <button onclick="showPendingPayments()" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i data-feather="credit-card" class="h-4 w-4 inline mr-2"></i>
                        Pay Pending Bookings
                    </button>
                    <button onclick="showPaymentHistory()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i data-feather="list" class="h-4 w-4 inline mr-2"></i>
                        View Payment History
                    </button>
                </div>
            </div>
        </div>

        <!-- Payments Table -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-medium text-gray-900">Payment History</h2>
                    <div class="flex space-x-2">
                        <select id="status-filter" class="border border-gray-300 rounded-md px-3 py-1 text-sm">
                            <option value="">All Status</option>
                            <option value="Pending">Pending</option>
                            <option value="Success">Success</option>
                            <option value="Failed">Failed</option>
                            <option value="Refunded">Refunded</option>
                        </select>
                        <select id="method-filter" class="border border-gray-300 rounded-md px-3 py-1 text-sm">
                            <option value="">All Methods</option>
                            <option value="Cash">Cash</option>
                            <option value="Card">Card</option>
                            <option value="UPI">UPI</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Booking Details</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Method</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="payments-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Payment rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Empty State -->
            <div id="empty-state" class="hidden text-center py-12">
                <i data-feather="credit-card" class="mx-auto h-12 w-12 text-gray-400"></i>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No payments found</h3>
                <p class="mt-1 text-sm text-gray-500">Get started by making your first booking payment.</p>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Process Payment</h3>
                    <button id="close-payment-modal" class="text-gray-400 hover:text-gray-600">
                        <i data-feather="x"></i>
                    </button>
                </div>
                <form id="payment-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Booking Details</label>
                        <div id="booking-details" class="p-3 bg-gray-50 rounded-md text-sm">
                            <!-- Booking details will be populated here -->
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="payment-amount" class="block text-sm font-medium text-gray-700 mb-2">Amount (₹)</label>
                        <input type="number" id="payment-amount" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500" readonly>
                    </div>
                    <div class="mb-4">
                        <label for="payment-method" class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                        <select id="payment-method" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500" required>
                            <option value="">Select payment method</option>
                            <option value="Cash">Cash</option>
                            <option value="Card">Card</option>
                            <option value="UPI">UPI</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-payment-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-md hover:bg-primary-700">
                            Process Payment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const API_BASE_URL = 'http://localhost:5000/api';
        
        // Debug function to test authentication - call from browser console
        function debugAuth() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');
            
            console.log('=== AUTHENTICATION DEBUG ===');
            console.log('Token exists:', !!token);
            console.log('Token length:', token ? token.length : 0);
            console.log('User data exists:', !!user);
            
            if (token) {
                console.log('Token sample:', token.substring(0, 30) + '...');
                
                // Test token by calling auth profile endpoint
                fetch(`${API_BASE_URL}/auth/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(response => {
                    console.log('Auth test response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Auth test response:', data);
                })
                .catch(error => {
                    console.error('Auth test error:', error);
                });
            }
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    console.log('User data:', userData);
                } catch (e) {
                    console.log('User data (raw):', user);
                }
            }
            
            console.log('============================');
        }
        let currentPayments = [];
        let currentBookingId = null;

        // Initialize page
        async function initializePage() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            // Show relevant sections based on user role
            if (user.userType === 'venue_owner') {
                document.getElementById('payment-stats').classList.remove('hidden');
                await loadPaymentStats();
            } else if (user.userType === 'player') {
                document.getElementById('player-actions').classList.remove('hidden');
            }
            
            await loadPayments();
            setupEventListeners();
            feather.replace();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Filter changes
            document.getElementById('status-filter').addEventListener('change', applyFilters);
            document.getElementById('method-filter').addEventListener('change', applyFilters);
            
            // Modal controls
            document.getElementById('close-payment-modal').addEventListener('click', closePaymentModal);
            document.getElementById('cancel-payment-btn').addEventListener('click', closePaymentModal);
            document.getElementById('payment-form').addEventListener('submit', processPayment);
            
            // Close modal when clicking outside
            document.getElementById('payment-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('payment-modal')) {
                    closePaymentModal();
                }
            });
        }

        // Load payment statistics (for venue owners)
        async function loadPaymentStats() {
            try {
                const token = localStorage.getItem('authToken');
                
                if (!token) {
                    console.error('No token for payment stats');
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/payments`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const payments = data.payments || [];
                    
                    const totalRevenue = payments
                        .filter(p => p.Status === 'Success')
                        .reduce((sum, p) => sum + parseFloat(p.Amount || 0), 0);
                    
                    const completedCount = payments.filter(p => p.Status === 'Success').length;
                    const pendingCount = payments.filter(p => p.Status === 'Pending').length;
                    const failedCount = payments.filter(p => p.Status === 'Failed').length;
                    
                    document.getElementById('total-revenue').textContent = `₹${totalRevenue.toFixed(2)}`;
                    document.getElementById('completed-payments').textContent = completedCount;
                    document.getElementById('pending-payments').textContent = pendingCount;
                    document.getElementById('failed-payments').textContent = failedCount;
                }
            } catch (error) {
                console.error('Error loading payment stats:', error);
            }
        }

        // Load payments
        async function loadPayments() {
            try {
                const token = localStorage.getItem('authToken');
                const user = localStorage.getItem('user');
                
                console.log('=== AUTH DEBUG ===');
                console.log('Token present:', token ? 'YES' : 'NO');
                console.log('Token length:', token ? token.length : 0);
                console.log('User data present:', user ? 'YES' : 'NO');
                if (token) {
                    console.log('Token preview:', token.substring(0, 20) + '...');
                }
                console.log('==================');
                
                if (!token) {
                    console.error('No token available - redirecting to login');
                    alert('Please log in to view payments');
                    window.location.href = 'login.html';
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/payments?_t=${Date.now()}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentPayments = data.payments || [];
                    displayPayments(currentPayments);
                } else {
                    const errorData = await response.json();
                    console.error('Failed to load payments:', response.status, errorData);
                    
                    if (response.status === 401) {
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    displayPayments([]);
                }
            } catch (error) {
                console.error('Error loading payments:', error);
                displayPayments([]);
            }
        }

        // Display payments in table
        function displayPayments(payments) {
            const tbody = document.getElementById('payments-table-body');
            const emptyState = document.getElementById('empty-state');

            if (payments.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            
            tbody.innerHTML = payments.map(payment => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        #${payment.PaymentID}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div>
                            <div class="font-medium">${payment.VenueName || 'N/A'}</div>
                            <div class="text-gray-500">Booking #${payment.BookingID}</div>
                            ${payment.BookingDate ? `<div class="text-gray-500">${new Date(payment.BookingDate).toLocaleDateString()}</div>` : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ₹${parseFloat(payment.Amount || 0).toFixed(2)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                            payment.PaymentMethod === 'Cash' ? 'bg-green-100 text-green-800' :
                            payment.PaymentMethod === 'Card' ? 'bg-blue-100 text-blue-800' :
                            payment.PaymentMethod === 'UPI' ? 'bg-purple-100 text-purple-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${payment.PaymentMethod || 'N/A'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                            payment.Status === 'Success' ? 'bg-green-100 text-green-800' :
                            payment.Status === 'Pending' ? 'bg-yellow-100 text-yellow-800' :
                            payment.Status === 'Failed' ? 'bg-red-100 text-red-800' :
                            payment.Status === 'Refunded' ? 'bg-gray-100 text-gray-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${payment.Status || 'Unknown'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${payment.TransactionDate ? new Date(payment.TransactionDate).toLocaleDateString() : 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewPaymentDetails(${payment.PaymentID})" class="text-primary-600 hover:text-primary-900 mr-2">
                            <i data-feather="eye" class="h-4 w-4"></i>
                        </button>
                        ${payment.Status === 'Pending' ? `
                            <button onclick="retryPayment(${payment.PaymentID})" class="text-green-600 hover:text-green-900 mr-2" title="Retry Payment">
                                <i data-feather="refresh-cw" class="h-4 w-4"></i>
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');

            feather.replace();
        }

        // Apply filters
        function applyFilters() {
            const statusFilter = document.getElementById('status-filter').value;
            const methodFilter = document.getElementById('method-filter').value;

            let filteredPayments = [...currentPayments];

            if (statusFilter) {
                filteredPayments = filteredPayments.filter(payment => payment.Status === statusFilter);
            }

            if (methodFilter) {
                filteredPayments = filteredPayments.filter(payment => payment.PaymentMethod === methodFilter);
            }

            displayPayments(filteredPayments);
        }

        // Show pending payments for players
        async function showPendingPayments() {
            try {
                const token = localStorage.getItem('authToken');
                console.log('Token:', token ? 'Present' : 'Missing');
                
                if (!token) {
                    alert('Please log in again');
                    window.location.href = 'login.html';
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/payments/my`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Payments data:', data);
                    const pendingPayments = data.payments.filter(payment => 
                        payment.Status === 'Pending'
                    );

                    if (pendingPayments.length > 0) {
                        console.log('First pending payment:', pendingPayments[0]);
                        // Show the first pending payment
                        showPaymentModal(pendingPayments[0]);
                    } else {
                        alert('No pending payments found!');
                    }
                } else {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                    alert(`Failed to load payments: ${errorData.message || 'Unknown error'}`);
                    
                    if (response.status === 401) {
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                    }
                }
            } catch (error) {
                console.error('Error loading pending payments:', error);
                alert('Error loading pending payments');
            }
        }

        // Show payment history (filter current view)
        function showPaymentHistory() {
            document.getElementById('status-filter').value = '';
            document.getElementById('method-filter').value = '';
            applyFilters();
        }

        // Show payment modal
        function showPaymentModal(booking) {
            currentBookingId = booking.BookingID;
            
            document.getElementById('booking-details').innerHTML = `
                <div><strong>Venue:</strong> ${booking.VenueName || 'N/A'}</div>
                <div><strong>Date:</strong> ${booking.BookingDate ? new Date(booking.BookingDate).toLocaleDateString() : 'N/A'}</div>
                <div><strong>Time:</strong> ${booking.StartTime || 'N/A'} - ${booking.EndTime || 'N/A'}</div>
                <div><strong>Booking ID:</strong> #${booking.BookingID}</div>
            `;
            
            document.getElementById('payment-amount').value = booking.TotalAmount || 0;
            document.getElementById('payment-method').value = '';
            
            document.getElementById('payment-modal').classList.remove('hidden');
            feather.replace();
        }

        // Close payment modal
        function closePaymentModal() {
            document.getElementById('payment-modal').classList.add('hidden');
            document.getElementById('payment-form').reset();
            currentBookingId = null;
        }

        // Process payment
        async function processPayment(event) {
            event.preventDefault();

            if (!currentBookingId) {
                alert('No booking selected for payment');
                return;
            }

            const amount = document.getElementById('payment-amount').value;
            const method = document.getElementById('payment-method').value;

            if (!amount || !method) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/payments/process`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        BookingID: currentBookingId,
                        Amount: parseFloat(amount),
                        PaymentMethod: method
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Payment processed successfully!');
                    closePaymentModal();
                    loadPayments(); // Refresh the payments list
                    
                    // Refresh stats if venue owner
                    const user = JSON.parse(localStorage.getItem('user') || '{}');
                    if (user.userType === 'venue_owner') {
                        loadPaymentStats();
                    }
                } else {
                    const errorData = await response.json().catch(() => ({ message: 'Unknown error' }));
                    alert('Payment failed: ' + (errorData.message || response.status));
                }
            } catch (error) {
                console.error('Error processing payment:', error);
                alert('Error processing payment: ' + error.message);
            }
        }

        // View payment details
        async function viewPaymentDetails(paymentId) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/payments/${paymentId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const payment = data.payment;
                    
                    alert(`Payment Details:\n\nPayment ID: #${payment.PaymentID}\nBooking ID: #${payment.BookingID}\nAmount: ₹${payment.Amount}\nMethod: ${payment.PaymentMethod}\nStatus: ${payment.Status}\nDate: ${new Date(payment.TransactionDate).toLocaleDateString()}\nVenue: ${payment.VenueName || 'N/A'}`);
                } else {
                    alert('Failed to load payment details');
                }
            } catch (error) {
                console.error('Error loading payment details:', error);
                alert('Error loading payment details');
            }
        }

        // Retry payment
        function retryPayment(paymentId) {
            // This would typically involve payment gateway integration
            alert('Retry payment functionality would be implemented with payment gateway integration');
        }

        // Dashboard redirect
        function redirectToDashboard() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (user.userType === 'admin') {
                window.location.href = 'admin-dashboard.html';
            } else if (user.userType === 'venue_owner') {
                window.location.href = 'venue-owner-dashboard.html';
            } else {
                window.location.href = 'player-dashboard.html';
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            localStorage.removeItem('authToken');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>