<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matches - TeamTango</title>
    <link rel="stylesheet" href="styles.css">
    <script src="utils.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
    </style>
    
    <!-- Authentication Check -->
    <script>
        // Check authentication on page load
        function checkAuthentication() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token || !user.userId) {
                // Show loading message briefly then redirect
                document.body.innerHTML = `
                    <div class="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div class="text-center">
                            <i data-feather="lock" class="h-16 w-16 text-red-500 mx-auto mb-4"></i>
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Authentication Required</h2>
                            <p class="text-gray-600 mb-4">You need to log in to access matches.</p>
                            <p class="text-sm text-gray-500">Redirecting to login page...</p>
                        </div>
                    </div>
                `;
                
                // Replace feather icons and redirect after 2 seconds
                if (typeof feather !== 'undefined') feather.replace();
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                
                return false;
            }
            
            return true;
        }
        
        // Check auth immediately when script loads
        if (!checkAuthentication()) {
            // Stop further script execution if not authenticated
            throw new Error('Authentication required');
        }
    </script>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="index.html" class="flex-shrink-0 flex items-center">
                        <i data-feather="activity" class="text-primary-600 h-8 w-8"></i>
                        <span class="ml-2 text-xl font-bold text-primary-600">TeamTango</span>
                    </a>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="player-dashboard.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Dashboard</a>
                        <a href="teams.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">My Teams</a>
                        <a href="venues.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Venues</a>
                        <a href="matches.html" class="border-primary-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Matches</a>
                        <a href="payments.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Payments</a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="p-1 rounded-full text-gray-400 hover:text-gray-500 focus:outline-none">
                        <i data-feather="bell"></i>
                    </button>
                    
                    <!-- User Menu -->
                    <div class="relative">
                        <button onclick="toggleUserMenu()" class="flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            <div class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center">
                                <span id="user-initials" class="text-primary-600 font-medium text-sm">U</span>
                            </div>
                            <span id="user-name" class="ml-2 text-gray-700 font-medium">User</span>
                        </button>
                        
                        <div id="user-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                            <a href="#" onclick="logout()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign out</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="md:flex md:items-center md:justify-between mb-8">
            <div class="flex-1 min-w-0">
                <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                    Matches
                </h2>
                <p class="mt-1 text-sm text-gray-500">
                    View, schedule, and manage your team matches.
                </p>
            </div>
            <div class="mt-4 flex md:mt-0 md:ml-4">
                <button type="button" id="schedule-match-btn" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700">
                    <i data-feather="plus" class="mr-2 h-4 w-4"></i>
                    Schedule Match
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="border-b border-gray-200 mb-8">
            <nav class="-mb-px flex space-x-8">
                <button class="tab-btn active whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" data-tab="upcoming">
                    Upcoming Matches
                </button>
                <button class="tab-btn whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" data-tab="completed">
                    Completed Matches
                </button>
                <button class="tab-btn whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" data-tab="cancelled">
                    Cancelled Matches
                </button>
            </nav>
        </div>

        <!-- Matches Content -->
        <div id="upcoming-tab" class="tab-content">
            <div id="upcoming-matches" class="space-y-4">
                <!-- Upcoming matches will be loaded here -->
            </div>
        </div>

        <div id="completed-tab" class="tab-content hidden">
            <div id="completed-matches" class="space-y-4">
                <!-- Completed matches will be loaded here -->
            </div>
        </div>

        <div id="cancelled-tab" class="tab-content hidden">
            <div id="cancelled-matches" class="space-y-4">
                <!-- Cancelled matches will be loaded here -->
            </div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-12">
            <i data-feather="calendar" class="mx-auto h-12 w-12 text-gray-400"></i>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No matches found</h3>
            <p class="mt-1 text-sm text-gray-500">Schedule your first match to get started.</p>
            <div class="mt-6">
                <button type="button" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">
                    <i data-feather="plus" class="mr-2 h-4 w-4"></i>
                    Schedule Match
                </button>
            </div>
        </div>
    </div>

    <!-- Schedule Match Modal -->
    <div id="match-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Schedule New Match</h3>
                    <button id="close-match-modal" class="text-gray-400 hover:text-gray-600">
                        <i data-feather="x"></i>
                    </button>
                </div>
                <form id="match-form">
                    <div class="mb-4">
                        <label for="match-sport" class="block text-sm font-medium text-gray-700 mb-2">Sport</label>
                        <select id="match-sport" name="sport" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500" required>
                            <option value="">Select sport</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="match-team1" class="block text-sm font-medium text-gray-700 mb-2">Your Team</label>
                        <select id="match-team1" name="team1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500" required>
                            <option value="">Select your team</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="match-team2" class="block text-sm font-medium text-gray-700 mb-2">Opponent Team</label>
                        <select id="match-team2" name="team2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500" required>
                            <option value="">Select opponent team</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="match-venue" class="block text-sm font-medium text-gray-700 mb-2">Venue</label>
                        <select id="match-venue" name="venue" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500" required>
                            <option value="">Select venue</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="match-date" class="block text-sm font-medium text-gray-700 mb-2">Match Date</label>
                        <input type="date" id="match-date" name="date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="match-time" class="block text-sm font-medium text-gray-700 mb-2">Match Time</label>
                        <input type="time" id="match-time" name="time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="match-description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="match-description" name="description" rows="3" placeholder="Additional details about the match" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-match-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-md hover:bg-primary-700">
                            Schedule Match
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        feather.replace();
        
        const API_BASE_URL = 'http://localhost:5000/api';

        // User menu toggle
        function toggleUserMenu() {
            const menu = document.getElementById('user-menu');
            menu.classList.toggle('hidden');
        }

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // Close user menu when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.getElementById('user-menu');
            const userButton = event.target.closest('button[onclick*="toggleUserMenu"]');
            
            if (!userButton && userMenu && !userMenu.classList.contains('hidden')) {
                userMenu.classList.add('hidden');
            }
        });

        // Sample data
        const sampleMatches = [
            {
                MatchID: 1,
                Team1: "Thunder Bolts",
                Team2: "Lightning Eagles",
                Venue: "Sports Complex Arena",
                MatchDate: "2024-10-15",
                MatchTime: "15:00",
                Status: "Upcoming",
                Description: "Quarterly championship match",
                Result: null
            },
            {
                MatchID: 2,
                Team1: "Court Warriors",
                Team2: "Net Masters",
                Venue: "Tennis Club Elite",
                MatchDate: "2024-10-20",
                MatchTime: "10:00",
                Status: "Upcoming",
                Description: "Friendly doubles match",
                Result: null
            },
            {
                MatchID: 3,
                Team1: "Thunder Bolts",
                Team2: "City Hawks",
                Venue: "Green Field Stadium",
                MatchDate: "2024-09-28",
                MatchTime: "18:00",
                Status: "Completed",
                Description: "League match",
                Result: "Won 3-1"
            },
            {
                MatchID: 4,
                Team1: "Lightning Eagles",
                Team2: "Storm Riders",
                Venue: "Badminton Center",
                MatchDate: "2024-09-25",
                MatchTime: "14:00",
                Status: "Completed",
                Description: "Tournament semifinal",
                Result: "Lost 1-2"
            }
        ];

        const sampleTeams = [
            { TeamID: 1, TeamName: "Thunder Bolts" },
            { TeamID: 2, TeamName: "Lightning Eagles" },
            { TeamID: 3, TeamName: "Court Warriors" }
        ];

        const sampleVenues = [
            { VenueID: 1, VenueName: "Sports Complex Arena" },
            { VenueID: 2, VenueName: "Green Field Stadium" },
            { VenueID: 3, VenueName: "Tennis Club Elite" },
            { VenueID: 4, VenueName: "Badminton Center" }
        ];

        let currentTab = 'upcoming';

        // Tab functionality
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                switchTab(tabName);
            });
        });

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'border-primary-500', 'text-primary-600');
                btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active', 'border-primary-500', 'text-primary-600');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');

            currentTab = tabName;
            loadMatches();
        }

        // Load matches
        async function loadMatches() {
            try {
                console.log('Loading matches from API...');
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/matches?_t=${Date.now()}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const matches = await response.json();
                console.log('Matches loaded:', matches);
                displayMatches(matches);
            } catch (error) {
                console.error('Error loading matches:', error);
                // Display empty state instead of sample data
                displayMatches([]);
            }
        }

        // Display matches
        function displayMatches(allMatches) {
            const upcomingContainer = document.getElementById('upcoming-matches');
            const completedContainer = document.getElementById('completed-matches');
            const cancelledContainer = document.getElementById('cancelled-matches');

            // Backend returns Status field mapped from MatchStatus
            const upcoming = allMatches.filter(match => match.Status === 'Scheduled' || match.Status === 'Upcoming');
            const completed = allMatches.filter(match => match.Status === 'Completed');
            const cancelled = allMatches.filter(match => match.Status === 'Cancelled');

            console.log('Filtered matches:', { upcoming, completed, cancelled });

            upcomingContainer.innerHTML = renderMatches(upcoming, 'upcoming');
            completedContainer.innerHTML = renderMatches(completed, 'completed');
            cancelledContainer.innerHTML = renderMatches(cancelled, 'cancelled');

            feather.replace();
        }

        // Render matches
        function renderMatches(matches, type) {
            if (matches.length === 0) {
                return `
                    <div class="text-center py-8">
                        <i data-feather="calendar" class="mx-auto h-8 w-8 text-gray-400"></i>
                        <p class="mt-2 text-sm text-gray-500">No ${type} matches</p>
                    </div>
                `;
            }

            return matches.map(match => `
                <div class="bg-white shadow rounded-lg p-6 hover:shadow-lg transition-shadow duration-300">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2">
                                    <h3 class="text-lg font-medium text-gray-900">${match.Team1}</h3>
                                    <span class="text-gray-400">vs</span>
                                    <h3 class="text-lg font-medium text-gray-900">${match.Team2}</h3>
                                </div>
                                <div class="flex items-center mt-2 text-sm text-gray-500">
                                    <i data-feather="map-pin" class="h-4 w-4 mr-1"></i>
                                    <span>${match.Venue}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col items-end">
                            <div class="flex items-center text-sm text-gray-500 mb-1">
                                <i data-feather="calendar" class="h-4 w-4 mr-1"></i>
                                ${new Date(match.MatchDate).toLocaleDateString()}
                            </div>
                            <div class="flex items-center text-sm text-gray-500">
                                <i data-feather="clock" class="h-4 w-4 mr-1"></i>
                                ${match.MatchTime}
                            </div>
                        </div>
                    </div>
                    
                    ${match.Description ? `<p class="text-sm text-gray-600 mb-4">${match.Description}</p>` : ''}
                    
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            ${getStatusBadge(match.Status)}
                            ${match.Result ? `<span class="text-sm font-medium ${match.Result.includes('Won') ? 'text-green-600' : 'text-red-600'}">${match.Result}</span>` : ''}
                        </div>
                        <div class="flex space-x-2">
                            ${type === 'upcoming' ? `
                                <button onclick="editMatch(${match.MatchID})" class="text-primary-600 hover:text-primary-900 text-sm font-medium">
                                    Edit
                                </button>
                                <button onclick="cancelMatch(${match.MatchID})" class="text-red-600 hover:text-red-900 text-sm font-medium">
                                    Cancel
                                </button>
                            ` : ''}
                            ${type === 'completed' ? `
                                <button onclick="viewMatchDetails(${match.MatchID})" class="text-primary-600 hover:text-primary-900 text-sm font-medium">
                                    View Details
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Get status badge
        function getStatusBadge(status) {
            const badges = {
                'Upcoming': 'bg-blue-100 text-blue-800',
                'Completed': 'bg-green-100 text-green-800',
                'Cancelled': 'bg-red-100 text-red-800'
            };

            return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${badges[status]}">${status}</span>`;
        }

        // Load teams and venues for the form
        // Global storage for all data
        let allTeams = [];
        let allVenues = [];
        let allSports = [];

        async function loadSportsTeamsAndVenues() {
            try {
                const [sportsResponse, teamsResponse, venuesResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/sports`),
                    fetch(`${API_BASE_URL}/teams`),
                    fetch(`${API_BASE_URL}/venues`)
                ]);
                
                if (sportsResponse.ok && teamsResponse.ok && venuesResponse.ok) {
                    const sportsData = await sportsResponse.json();
                    const teamsData = await teamsResponse.json();
                    const venuesData = await venuesResponse.json();
                    
                    // Handle different response structures
                    allSports = sportsData.sports || sportsData;
                    allTeams = teamsData.teams || teamsData;
                    allVenues = venuesData.venues || venuesData;
                    
                    console.log('Loaded sports:', allSports.length);
                    console.log('Loaded teams:', allTeams.length);
                    console.log('Loaded venues:', allVenues.length);
                    
                    populateSportsSelect();
                    populateVenuesSelect();
                } else {
                    console.error('Failed to load data');
                    // Use sample data as fallback
                    populateVenuesSelect(sampleVenues);
                }
            } catch (error) {
                console.error('Error loading data:', error);
                // Use sample data as fallback
                populateVenuesSelect(sampleVenues);
            }
        }

        // Populate sports select
        function populateSportsSelect() {
            const sportSelect = document.getElementById('match-sport');
            sportSelect.innerHTML = '<option value="">Select sport</option>';
            
            allSports.forEach(sport => {
                const option = document.createElement('option');
                option.value = sport.SportID;
                option.textContent = sport.SportName;
                sportSelect.appendChild(option);
            });
        }

        // Populate teams select based on selected sport
        function populateTeamsSelect(sportId = null) {
            const team1Select = document.getElementById('match-team1');
            const team2Select = document.getElementById('match-team2');
            
            // Clear both dropdowns
            team1Select.innerHTML = '<option value="">Select your team</option>';
            team2Select.innerHTML = '<option value="">Select opponent team</option>';
            
            if (!sportId) return;
            
            // Filter teams by sport
            const filteredTeams = allTeams.filter(team => team.SportID == sportId);
            
            filteredTeams.forEach(team => {
                // Add to Team 1 dropdown
                const option1 = document.createElement('option');
                option1.value = team.TeamID;
                option1.textContent = team.TeamName;
                team1Select.appendChild(option1);
                
                // Add to Team 2 dropdown
                const option2 = document.createElement('option');
                option2.value = team.TeamID;
                option2.textContent = team.TeamName;
                team2Select.appendChild(option2);
            });
        }

        // Populate venues select
        function populateVenuesSelect(venues = null) {
            const venueSelect = document.getElementById('match-venue');
            venueSelect.innerHTML = '<option value="">Select venue</option>';
            
            const venueList = venues || allVenues;
            venueList.forEach(venue => {
                const option = document.createElement('option');
                option.value = venue.VenueID;
                option.textContent = venue.VenueName;
                venueSelect.appendChild(option);
            });
        }

        // Update Team 2 options (exclude selected Team 1)
        function updateTeam2Options(sportId, excludeTeamId) {
            const team2Select = document.getElementById('match-team2');
            team2Select.innerHTML = '<option value="">Select opponent team</option>';
            
            if (!sportId) return;
            
            // Filter teams by sport and exclude Team 1
            const filteredTeams = allTeams.filter(team => 
                team.SportID == sportId && team.TeamID != excludeTeamId
            );
            
            filteredTeams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.TeamID;
                option.textContent = team.TeamName;
                team2Select.appendChild(option);
            });
        }

        // Modal functionality
        const matchModal = document.getElementById('match-modal');
        const scheduleMatchBtn = document.getElementById('schedule-match-btn');
        const closeMatchModalBtn = document.getElementById('close-match-modal');
        const cancelMatchBtn = document.getElementById('cancel-match-btn');
        const matchForm = document.getElementById('match-form');

        scheduleMatchBtn.addEventListener('click', () => {
            // Reset form to create mode
            matchForm.reset();
            delete matchForm.dataset.editMode;
            delete matchForm.dataset.matchId;
            
            // Reset modal title and button text
            document.querySelector('#match-modal h3').textContent = 'Schedule New Match';
            document.querySelector('#match-form button[type="submit"]').textContent = 'Schedule Match';
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('match-date').setAttribute('min', today);
            
            matchModal.classList.remove('hidden');
        });

        closeMatchModalBtn.addEventListener('click', () => {
            matchModal.classList.add('hidden');
            matchForm.reset();
        });

        cancelMatchBtn.addEventListener('click', () => {
            matchModal.classList.add('hidden');
            matchForm.reset();
        });

        // Close modal when clicking outside
        matchModal.addEventListener('click', (e) => {
            if (e.target === matchModal) {
                matchModal.classList.add('hidden');
                matchForm.reset();
            }
        });

        // Handle sport selection change
        document.getElementById('match-sport').addEventListener('change', (e) => {
            const selectedSportId = e.target.value;
            populateTeamsSelect(selectedSportId);
        });

        // Handle Team 1 selection change to update Team 2 options
        document.getElementById('match-team1').addEventListener('change', (e) => {
            const selectedTeam1Id = e.target.value;
            const selectedSportId = document.getElementById('match-sport').value;
            updateTeam2Options(selectedSportId, selectedTeam1Id);
        });

        // Schedule match
        matchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const isEditMode = matchForm.dataset.editMode === 'true';
            const matchId = matchForm.dataset.matchId;
            
            const formData = new FormData(matchForm);
            
            // Get team names for match title
            const team1Id = parseInt(formData.get('team1'));
            const team2Id = parseInt(formData.get('team2'));
            
            // Validation: Teams cannot play against themselves
            if (team1Id === team2Id) {
                alert('Please select different teams for Team 1 and Team 2');
                return;
            }
            
            const team1Name = allTeams.find(t => t.TeamID === team1Id)?.TeamName || 'Team 1';
            const team2Name = allTeams.find(t => t.TeamID === team2Id)?.TeamName || 'Team 2';
            
            const matchData = {
                MatchTitle: `${team1Name} vs ${team2Name}`,
                Team1ID: team1Id,
                Team2ID: team2Id,
                VenueID: parseInt(formData.get('venue')),
                MatchDate: formData.get('date'),
                MatchTime: formData.get('time')
            };

            console.log('Sending match data:', matchData);

            try {
                const token = localStorage.getItem('token');
                
                let response;
                if (isEditMode) {
                    // Update existing match
                    response = await fetch(`${API_BASE_URL}/matches/update/${matchId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(matchData)
                    });
                } else {
                    // Create new match
                    response = await fetch(`${API_BASE_URL}/matches/create`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(matchData)
                    });
                }

                if (response.ok) {
                    const result = await response.json();
                    console.log(isEditMode ? 'Match updated successfully:' : 'Match scheduled successfully:', result);
                    alert(isEditMode ? 'Match updated successfully!' : 'Match scheduled successfully!');
                    matchModal.classList.add('hidden');
                    matchForm.reset();
                    
                    // Reset edit mode
                    delete matchForm.dataset.editMode;
                    delete matchForm.dataset.matchId;
                    
                    // Reset modal title and button
                    document.querySelector('#match-modal h3').textContent = 'Schedule New Match';
                    document.querySelector('#match-form button[type="submit"]').textContent = 'Schedule Match';
                    
                    loadMatches(); // Reload matches
                } else {
                    const errorData = await response.json().catch(() => ({ message: 'Unknown error' }));
                    console.error('Error with match:', response.status, errorData);
                    alert('Error: ' + (errorData.message || response.status));
                }
            } catch (error) {
                console.error('Error with match:', error);
                alert('Error: ' + error.message);
            }
        });

        // Match actions
        async function editMatch(matchId) {
            console.log('Edit match clicked for ID:', matchId);
            
            try {
                const token = localStorage.getItem('token');
                
                // Fetch the match details
                const response = await fetch(`${API_BASE_URL}/matches/${matchId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const match = await response.json();
                    console.log('Fetched match data:', match);
                    
                    // Find the sport ID from the team
                    const team1 = allTeams.find(t => t.TeamID == match.Team1ID);
                    const sportId = team1 ? team1.SportID : null;
                    
                    if (sportId) {
                        // Set sport and populate teams
                        document.getElementById('match-sport').value = sportId;
                        populateTeamsSelect(sportId);
                        
                        // After populating, set the team values
                        setTimeout(() => {
                            document.getElementById('match-team1').value = match.Team1ID || '';
                            document.getElementById('match-team2').value = match.Team2ID || '';
                        }, 100);
                    }
                    
                    // Set other fields
                    document.getElementById('match-venue').value = match.VenueID || '';
                    document.getElementById('match-date').value = match.MatchDate ? match.MatchDate.split('T')[0] : '';
                    document.getElementById('match-time').value = match.MatchTime || '';
                    
                    // Description field might not be in the database, so handle gracefully
                    const descField = document.getElementById('match-description');
                    if (descField) {
                        descField.value = match.Description || '';
                    }
                    
                    // Change modal title and button text
                    document.querySelector('#match-modal h3').textContent = 'Edit Match';
                    const submitBtn = document.querySelector('#match-form button[type="submit"]');
                    submitBtn.textContent = 'Update Match';
                    
                    // Store the match ID for update
                    document.getElementById('match-form').dataset.editMode = 'true';
                    document.getElementById('match-form').dataset.matchId = matchId;
                    
                    // Show the modal
                    document.getElementById('match-modal').classList.remove('hidden');
                    feather.replace();
                } else {
                    alert('Failed to load match details');
                }
            } catch (error) {
                console.error('Error loading match for edit:', error);
                alert('Error loading match details');
            }
        }

        async function cancelMatch(matchId) {
            if (!confirm('Are you sure you want to cancel this match?')) return;

            const btn = event?.target;
            if (btn) btn.setAttribute('disabled', 'disabled');

            try {
                const token = localStorage.getItem('token');
                console.log('Cancel match - token present?', !!token);

                const response = await fetch(`${API_BASE_URL}/matches/update/${matchId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ MatchStatus: 'Cancelled' })
                });

                if (response.ok) {
                    alert('Match cancelled successfully');
                    loadMatches(); // Reload matches to show updated status
                } else {
                    const text = await response.text();
                    let parsed = null;
                    try { parsed = JSON.parse(text); } catch(e) { parsed = { message: text }; }
                    console.error('Cancel failed:', response.status, parsed);
                    alert('Error cancelling match: ' + (parsed.message || response.status));
                }
            } catch (error) {
                console.error('Error cancelling match:', error);
                alert('Error cancelling match: ' + error.message);
            } finally {
                if (btn) btn.removeAttribute('disabled');
            }
        }

        function viewMatchDetails(matchId) {
            console.log('View match details clicked for ID:', matchId);
            // TODO: Implement match details view
        }

        // Dashboard redirect function
        function redirectToDashboard() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token || !user.userId) {
                window.location.href = 'login.html';
                return;
            }
            
            const userType = user.userType || user.roleId;
            
            if (userType === 'player' || userType === 1) {
                window.location.href = 'player-dashboard.html';
            } else if (userType === 'venue_owner' || userType === 2) {
                window.location.href = 'venue-owner-dashboard.html';
            } else if (userType === 'admin' || userType === 3) {
                window.location.href = 'admin-dashboard.html';
            } else {
                window.location.href = 'index.html';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadMatches();
            loadSportsTeamsAndVenues();
        });
    </script>
</body>
</html>